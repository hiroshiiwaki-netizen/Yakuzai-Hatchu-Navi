<script>
    /**
     * è–¬å‰¤ç™ºæ³¨ãƒŠãƒ“ v25.0 - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
     * scripts.html
     * æœ€çµ‚æ›´æ–°: 2026-01-16
     * v25.0: ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼èµ·å‹•ç”»é¢ã€å®šæœŸç™ºæ³¨æ©Ÿèƒ½å¯¾å¿œ
     */

    // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
    let patientsMaster = [];
    let staffMaster = [];
    let currentUser = {};
    let allOrders = [];
    let selectedIds = new Set();
    let loadTimer;
    let slideTimer;  // v25.0: ã‚¹ãƒ©ã‚¤ãƒ‰åˆ‡æ›¿ç”¨ã‚¿ã‚¤ãƒãƒ¼
    let currentSlide = 0;  // v25.0: ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ç•ªå·
    let currentPage = 'list';
    let currentFilter = '';

    // ===== åˆæœŸåŒ– =====
    window.onload = () => {
        // v25.0: ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼é–‹å§‹
        startSlideshow();

        // èªè¨¼é–‹å§‹ï¼ˆã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã¯å‰Šé™¤æ¸ˆã¿ï¼‰
        step1_Auth();
    };

    // v25.0: ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼åˆ¶å¾¡
    function startSlideshow() {
        const slides = document.querySelectorAll('.slide');
        const indicators = document.querySelectorAll('.indicator');

        if (slides.length === 0) return;

        slideTimer = setInterval(() => {
            // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’éè¡¨ç¤º
            slides[currentSlide].classList.remove('active');
            indicators[currentSlide].classList.remove('active');

            // æ¬¡ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã¸
            currentSlide = (currentSlide + 1) % slides.length;

            // æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¡¨ç¤º
            slides[currentSlide].classList.add('active');
            indicators[currentSlide].classList.add('active');
        }, 3000);  // 3ç§’ã”ã¨ã«åˆ‡æ›¿
    }

    function stopSlideshow() {
        if (slideTimer) {
            clearInterval(slideTimer);
            slideTimer = null;
        }
    }

    function forceStart() {
        clearTimeout(loadTimer);
        stopSlideshow();
        document.getElementById('app-loading').style.display = 'none';
    }

    function updateProgress(percent, text) {
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('loading-text').innerText = text;
    }

    // ===== èªè¨¼ =====
    function step1_Auth() {
        updateProgress(10, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ä¸­...');
        google.script.run.withSuccessHandler(res => {
            if (!res.success) {
                console.error(res.message);
                alert(res.message);
                return;
            }
            currentUser = { email: res.email, name: res.email };
            document.getElementById('header-username').innerText = res.email;
            document.getElementById('staff-email-hidden').value = res.email;
            step2_Masters();
        }).withFailureHandler(e => {
            console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', e);
            step2_Masters();
        }).step1_SimpleAuth();
    }

    // ===== ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾— =====
    function step2_Masters() {
        updateProgress(40, 'ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');
        google.script.run.withSuccessHandler(res => {
            if (res.patients) patientsMaster = res.patients;
            if (res.staff) {
                staffMaster = res.staff;
                const me = staffMaster.find(s => s.email === currentUser.email);
                if (me) {
                    currentUser.name = me.name;
                    currentUser.role = me.role || '';
                    currentUser.dept = me.dept || '';

                    // ã€Œåå‰(æ‰€å±ãƒ‡ãƒ è·ç¨®)ã€å½¢å¼ã§è¡¨ç¤º
                    let displayText = me.name;
                    if (me.dept || me.role) {
                        const details = [me.dept, me.role].filter(x => x).join(' ');
                        displayText = `${me.name}(${details})`;
                    }
                    document.getElementById('header-username').innerText = displayText;
                    document.getElementById('staff-name-display').value = me.name;
                } else {
                    document.getElementById('staff-name-display').value = currentUser.email;
                }
                populateStaffSelects();
            }
            step3_Orders();
        }).withFailureHandler(e => {
            console.error('ãƒã‚¹ã‚¿ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            step3_Orders();
        }).step2_GetMasters();
    }

    // ===== ç™ºæ³¨ãƒªã‚¹ãƒˆå–å¾— =====
    function step3_Orders() {
        updateProgress(70, 'ç™ºæ³¨ãƒªã‚¹ãƒˆå–å¾—ä¸­...');
        google.script.run.withSuccessHandler(res => {
            if (res.orders) {
                allOrders = res.orders;
                applyFilters();
            }
            updateProgress(100, 'å®Œäº†');
            clearTimeout(loadTimer);
            setTimeout(() => document.getElementById('app-loading').style.display = 'none', 300);
        }).withFailureHandler(e => {
            console.error('ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            alert('ãƒªã‚¹ãƒˆèª­è¾¼å¤±æ•—: ' + e);
        }).step3_GetOrders();
    }

    // ===== ã‚¹ã‚¿ãƒƒãƒ•é¸æŠè‚¢ã‚’è¨­å®š =====
    let selectedStaffFilter = '';  // v25.0: é¸æŠã•ã‚ŒãŸæ‹…å½“è€…ã®emailã‚’ä¿æŒ

    function populateStaffSelects() {
        const editSelect = document.getElementById('edit-pic-select');

        // ç·¨é›†ç”»é¢ç”¨ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã¿æ›´æ–°
        editSelect.innerHTML = '';
        staffMaster.forEach(s => {
            editSelect.innerHTML += `<option value="${s.email}">${s.name}</option>`;
        });
    }

    // v25.0: æ‹…å½“è€…æ¤œç´¢ï¼ˆã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼‰
    function searchStaffFilter() {
        const input = document.getElementById('filter-pic-input');
        const resultsBox = document.getElementById('filter-pic-results');
        const clearBtn = document.getElementById('filter-pic-clear');
        const query = input.value.trim().toLowerCase();

        // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡
        clearBtn.style.display = query ? 'flex' : 'none';

        if (!query) {
            resultsBox.style.display = 'none';
            // å…¥åŠ›ã‚¯ãƒªã‚¢æ™‚ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚è§£é™¤
            if (selectedStaffFilter) {
                selectedStaffFilter = '';
                applyFilters();
            }
            return;
        }

        // ã‚¹ã‚¿ãƒƒãƒ•æ¤œç´¢
        const matches = staffMaster.filter(s =>
            (s.name && s.name.toLowerCase().includes(query)) ||
            (s.dept && s.dept.toLowerCase().includes(query))
        );

        if (matches.length === 0) {
            resultsBox.innerHTML = '<div class="staff-search-no-results">è©²å½“ãªã—</div>';
            resultsBox.style.display = 'block';
            return;
        }

        resultsBox.innerHTML = '';
        matches.slice(0, 10).forEach(s => {
            const item = document.createElement('div');
            item.className = 'staff-search-item';
            if (s.email === selectedStaffFilter) {
                item.classList.add('selected');
            }
            item.innerHTML = `
                <span class="staff-icon">ğŸ‘¤</span>
                <span class="staff-name">${s.name}</span>
                <span style="font-size:12px;color:var(--text-muted);">${s.dept || ''}</span>
            `;
            item.onclick = () => selectStaffFilter(s);
            resultsBox.appendChild(item);
        });
        resultsBox.style.display = 'block';
    }

    function selectStaffFilter(staff) {
        const input = document.getElementById('filter-pic-input');
        const resultsBox = document.getElementById('filter-pic-results');
        const clearBtn = document.getElementById('filter-pic-clear');

        selectedStaffFilter = staff.email;
        input.value = staff.name;
        resultsBox.style.display = 'none';
        clearBtn.style.display = 'flex';

        applyFilters();
    }

    function clearStaffFilter() {
        const input = document.getElementById('filter-pic-input');
        const resultsBox = document.getElementById('filter-pic-results');
        const clearBtn = document.getElementById('filter-pic-clear');

        selectedStaffFilter = '';
        input.value = '';
        resultsBox.style.display = 'none';
        clearBtn.style.display = 'none';

        applyFilters();
    }

    // ===== æ¤œç´¢ã‚µã‚¸ã‚§ã‚¹ãƒˆ =====
    function setupSearch(inputId, suggestId) {
        const input = document.getElementById(inputId);
        const box = document.getElementById(suggestId);
        let isComposing = false; // æ—¥æœ¬èªå¤‰æ›ä¸­ãƒ•ãƒ©ã‚°

        function doSearch() {
            // å¤‰æ›ä¸­ã¯æ¤œç´¢ã—ãªã„
            if (isComposing) {
                console.log('å¤‰æ›ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }

            const val = input.value.trim();
            console.log('æ¤œç´¢:', val, 'ãƒã‚¹ã‚¿ãƒ¼ä»¶æ•°:', patientsMaster.length);
            box.innerHTML = '';
            if (!val) {
                box.style.display = 'none';
                return;
            }
            const matches = patientsMaster.filter(p =>
                (p.name && p.name.includes(val)) || (p.kana && p.kana.includes(val))
            );
            console.log('ãƒãƒƒãƒæ•°:', matches.length);
            if (matches.length > 0) {
                box.style.display = 'block';
                matches.slice(0, 10).forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `${p.name}<span class="suggestion-sub">${p.kana || ''}</span>`;
                    div.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        input.value = p.name;
                        box.style.display = 'none';
                    };
                    box.appendChild(div);
                });
            } else {
                box.style.display = 'none';
            }
        }

        // æ—¥æœ¬èªå…¥åŠ›é–‹å§‹
        input.addEventListener('compositionstart', () => {
            isComposing = true;
            console.log('å¤‰æ›é–‹å§‹');
        });

        // æ—¥æœ¬èªå…¥åŠ›ç¢ºå®šæ™‚ â†’ æ¤œç´¢å®Ÿè¡Œ
        input.addEventListener('compositionend', () => {
            isComposing = false;
            console.log('å¤‰æ›ç¢ºå®š');
            doSearch();
        });

        // é€šå¸¸å…¥åŠ›ï¼ˆè‹±æ•°å­—ãªã©ï¼‰
        input.addEventListener('input', doSearch);

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ã‚‚æ¤œç´¢
        input.addEventListener('focus', () => {
            if (input.value.trim() && !isComposing) {
                doSearch();
            }
        });

        // blurã§ã¯é–‰ã˜ãªã„ï¼ˆã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼‰
    }
    setupSearch('patientSearch', 'suggestions');
    setupSearch('edit-patient', 'edit-suggestions');

    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã®ã‚¿ãƒƒãƒ—ã§å€™è£œãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã®ã¿ï¼‰
    document.addEventListener('click', (e) => {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
        if (e.target.closest('.modal-content')) return;
        // å…¥åŠ›æ¬„ã‚„ã‚µã‚¸ã‚§ã‚¹ãƒˆå†…ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
        if (e.target.closest('.search-container')) return;
        if (e.target.closest('.suggestions')) return;

        const suggestions = document.querySelectorAll('.suggestions');
        suggestions.forEach(box => {
            box.style.display = 'none';
        });
    });

    // ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ =====
    function setFilter(filter) {
        currentFilter = filter;

        // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('.filter-tab').forEach(tab => {
            const tabFilter = tab.dataset.filter;
            tab.classList.toggle('active', tabFilter === filter);
        });

        applyFilters();
    }

    function toggleSearch() {
        const searchBar = document.getElementById('search-bar');
        const searchInput = document.getElementById('filter-search');

        if (searchBar.classList.contains('hidden')) {
            searchBar.classList.remove('hidden');
            searchInput.focus();
        } else {
            searchBar.classList.add('hidden');
            searchInput.value = '';
            applyFilters();
        }
    }

    function applyFilters() {
        // v25.0: ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‹ã‚‰é¸æŠã•ã‚ŒãŸå€¤ã‚’ä½¿ç”¨
        const picFilter = selectedStaffFilter || '';
        const searchText = document.getElementById('filter-search').value.trim().toLowerCase();

        let filtered = allOrders;

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (currentFilter) {
            filtered = filtered.filter(o => o.status === currentFilter);
        }

        // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (picFilter) {
            filtered = filtered.filter(o => o.picEmail === picFilter);
        }

        // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
        if (searchText) {
            filtered = filtered.filter(o =>
                (o.patient && o.patient.toLowerCase().includes(searchText)) ||
                (o.drug && o.drug.toLowerCase().includes(searchText))
            );
        }

        renderList(filtered);
    }

    // ===== ãƒªã‚¹ãƒˆæç”» =====
    function renderList(orders) {
        const container = document.getElementById('order-list');
        const bulkMode = selectedIds.size > 0;

        if (!orders || orders.length === 0) {
            container.innerHTML = `
      <div class="empty-state">
        <span class="material-icons">check_circle</span>
        <p>è¡¨ç¤ºã™ã‚‹ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
      </div>`;
            return;
        }

        const today = new Date().toISOString().split('T')[0];
        let html = '';

        orders.forEach(o => {
            const isUrgent = o.deadline <= today;
            const isSelected = selectedIds.has(o.id);

            const statusClass = o.status === 'æœªç™ºæ³¨' ? 'status-pending' : 'status-ordered';
            const cardClass = `order-card ${statusClass}${isSelected ? ' selected' : ''}${isUrgent ? ' urgent' : ''}`;
            const badgeClass = o.status === 'æœªç™ºæ³¨' ? 'pending' : 'ordered';
            const checkboxShow = bulkMode ? 'show' : '';

            // æœŸé™ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨ˆç®—
            const countdown = getCountdown(o.deadline);

            // v25.0: å®šæœŸç™ºæ³¨ã‚¢ã‚¤ã‚³ãƒ³
            const recurringIcon = o.isRecurring ? '<span class="recurring-icon" title="å®šæœŸç™ºæ³¨">ğŸ”„</span>' : '';

            const dataJson = JSON.stringify(o).replace(/"/g, '&quot;');

            html += `
      <div class="${cardClass}" data-id="${o.id}">
        <div class="card-checkbox ${checkboxShow}">
          <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="toggleSelect(event, '${o.id}')">
        </div>
        <div onclick="handleCardClick(event, ${dataJson})">
          <div class="card-header">
            <div class="drug-name">
              <span class="emoji">ğŸ’Š</span>${o.drug || '(è–¬å‰¤åãªã—)'}${recurringIcon}
            </div>
            <span class="status-badge ${badgeClass}">${o.status}</span>
          </div>
          <div class="patient-info">
            <span class="material-icons">person</span>
            ${o.patient} æ§˜
          </div>
          <div class="card-footer">
            <span class="deadline${isUrgent ? ' urgent' : ''}">
              <span class="material-icons">${isUrgent ? 'warning' : 'event'}</span>
              ${o.deadline}
              <span class="countdown ${countdown.class}">${countdown.text}</span>
            </span>
            <span>æ‹…å½“: ${o.pic}</span>
          </div>
        </div>
      </div>`;
        });

        container.innerHTML = html;
        updateBulkBar();
    }

    // ===== ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç† =====
    function handleCardClick(event, order) {
        if (selectedIds.size > 0) {
            toggleSelect(event, order.id);
        } else {
            openEditModal(order);
        }
    }

    // ===== ä¸€æ‹¬é¸æŠ =====
    function toggleSelect(event, id) {
        event.stopPropagation();

        if (selectedIds.has(id)) {
            selectedIds.delete(id);
        } else {
            selectedIds.add(id);
        }

        applyFilters();
    }

    function updateBulkBar() {
        const bulkBar = document.getElementById('bulk-bar');
        const countSpan = document.getElementById('bulk-count');

        if (selectedIds.size > 0) {
            bulkBar.classList.add('show');
            countSpan.innerText = `${selectedIds.size}ä»¶é¸æŠä¸­`;
            document.querySelectorAll('.card-checkbox').forEach(el => el.classList.add('show'));
        } else {
            bulkBar.classList.remove('show');
            document.querySelectorAll('.card-checkbox').forEach(el => el.classList.remove('show'));
        }
    }

    function cancelBulkSelect() {
        selectedIds.clear();
        applyFilters();
    }

    function bulkOrdered() {
        if (selectedIds.size === 0) return;
        if (!confirm(`${selectedIds.size}ä»¶ã‚’ã€Œç™ºæ³¨æ¸ˆã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        showLoading('ä¸€æ‹¬æ›´æ–°ä¸­...');
        const ids = Array.from(selectedIds);

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                alert(`${res.count}ä»¶ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
                selectedIds.clear();
                refreshList();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
                hideLoading();
            }
        }).withFailureHandler(e => {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
            hideLoading();
        }).bulkUpdateStatus(ids, 'ç™ºæ³¨æ¸ˆ', currentUser.name);
    }

    function bulkDelete() {
        if (selectedIds.size === 0) return;
        if (!confirm(`${selectedIds.size}ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;

        showLoading('ä¸€æ‹¬å‰Šé™¤ä¸­...');
        const ids = Array.from(selectedIds);

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                alert(`${res.count}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                selectedIds.clear();
                refreshList();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
                hideLoading();
            }
        }).withFailureHandler(e => {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
            hideLoading();
        }).bulkDelete(ids, currentUser.name);
    }

    // ===== ç™»éŒ² =====
    function save() {
        const form = {
            patient: document.getElementById('patientSearch').value,
            drug: document.getElementById('drug').value,
            deadline: document.getElementById('deadline').value,
            adminDate: document.getElementById('admin').value,
            picEmail: document.getElementById('staff-email-hidden').value,
            picName: document.getElementById('staff-name-display').value,
            // v25.0: å®šæœŸç™ºæ³¨è¨­å®š
            isRecurring: document.getElementById('is-recurring').checked,
            recurrenceType: null,
            recurrenceValue: null
        };

        // v25.0: å®šæœŸè¨­å®šã®å€¤ã‚’åé›†
        if (form.isRecurring) {
            form.recurrenceType = document.getElementById('recurrence-type').value;
            form.recurrenceValue = getRecurrenceValue(form.recurrenceType);
        }

        if (!form.patient || !form.deadline) {
            return alert('æ‚£è€…åã¨ç™ºæ³¨æœŸé™æ—¥ã¯å¿…é ˆã§ã™');
        }

        // v26.0: éå»æ—¥ãƒã‚§ãƒƒã‚¯
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const deadlineDate = new Date(form.deadline);
        if (deadlineDate < today) {
            alert('âš ï¸ ç™ºæ³¨æœŸé™ãŒéå»ã®æ—¥ä»˜ã§ã™ã€‚\næ­£ã—ã„æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        // v26.0: é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜æ‚£è€…ãƒ»è–¬å‰¤ãŒæœªç™ºæ³¨ãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‹ï¼‰
        if (form.drug) {
            const duplicate = allOrders.find(o =>
                o.patient === form.patient &&
                o.drug === form.drug &&
                o.status === 'æœªç™ºæ³¨'
            );
            if (duplicate) {
                const proceed = confirm(
                    `âš ï¸ åŒã˜æ‚£è€…ãƒ»è–¬å‰¤ã®ç™ºæ³¨ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n` +
                    `æ‚£è€…: ${duplicate.patient}\n` +
                    `è–¬å‰¤: ${duplicate.drug}\n` +
                    `æœŸé™: ${duplicate.deadline}\n\n` +
                    `ãã‚Œã§ã‚‚ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`
                );
                if (!proceed) return;
            }
        }

        const confirmMsg = form.isRecurring
            ? `å®šæœŸç™ºæ³¨ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿï¼ˆ${getRecurrenceLabel(form.recurrenceType, form.recurrenceValue)}ï¼‰`
            : 'ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ';

        if (!confirm(confirmMsg)) return;

        showLoading('ç™»éŒ²ä¸­...');
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                const msg = res.isRecurring ? 'å®šæœŸç™ºæ³¨ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼' : 'ç™»éŒ²å®Œäº†ï¼';
                alert(msg);
                closeModal('register-modal');
                clearRegisterForm();
                refreshList();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + (res.message || res.details?.join('\n')));
                hideLoading();
            }
        }).withFailureHandler(e => {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
            hideLoading();
        }).registerOrder(form);
    }

    // v26.0: æŠ•ä¸äºˆå®šæ—¥ã‹ã‚‰ç™ºæ³¨æœŸé™ã‚’è‡ªå‹•è¨ˆç®—ï¼ˆ3æ—¥å‰ï¼‰
    function autoSetDeadline() {
        const adminInput = document.getElementById('admin');
        const deadlineInput = document.getElementById('deadline');

        if (!adminInput.value) return;

        // æ—¢ã«ç™ºæ³¨æœŸé™ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„
        if (deadlineInput.value) return;

        const adminDate = new Date(adminInput.value);
        adminDate.setDate(adminDate.getDate() - 3);

        // YYYY-MM-DDå½¢å¼ã«å¤‰æ›
        const year = adminDate.getFullYear();
        const month = String(adminDate.getMonth() + 1).padStart(2, '0');
        const day = String(adminDate.getDate()).padStart(2, '0');

        deadlineInput.value = `${year}-${month}-${day}`;
    }

    function clearRegisterForm() {
        document.getElementById('patientSearch').value = '';
        document.getElementById('drug').value = '';
        document.getElementById('deadline').value = '';
        document.getElementById('admin').value = '';
        // v25.0: å®šæœŸè¨­å®šã‚‚ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('is-recurring').checked = false;
        document.getElementById('recurrence-settings').style.display = 'none';
        document.getElementById('recurrence-type').value = 'weekly';
        updateRecurrenceValue();
    }

    // ===== v25.0: å®šæœŸç™ºæ³¨UIåˆ¶å¾¡ =====
    function toggleRecurrenceSettings() {
        const isChecked = document.getElementById('is-recurring').checked;
        document.getElementById('recurrence-settings').style.display = isChecked ? 'block' : 'none';
    }

    function updateRecurrenceValue() {
        const type = document.getElementById('recurrence-type').value;

        // å…¨ã¦éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰è©²å½“ã®ã‚‚ã®ã ã‘è¡¨ç¤º
        document.getElementById('recurrence-weekday').style.display = 'none';
        document.getElementById('recurrence-date').style.display = 'none';
        document.getElementById('recurrence-week').style.display = 'none';

        if (type === 'weekly' || type === 'biweekly') {
            document.getElementById('recurrence-weekday').style.display = 'block';
        } else if (type === 'monthly_date') {
            document.getElementById('recurrence-date').style.display = 'block';
        } else if (type === 'monthly_week') {
            document.getElementById('recurrence-week').style.display = 'block';
        }
    }

    function getRecurrenceValue(type) {
        switch (type) {
            case 'weekly':
                return document.getElementById('recurrence-day').value;
            case 'biweekly':
                const day = document.getElementById('recurrence-day').value;
                const baseDate = document.getElementById('deadline').value;
                return `${day},${baseDate}`;
            case 'monthly_date':
                return document.getElementById('recurrence-date-value').value;
            case 'monthly_week':
                const weekNum = document.getElementById('recurrence-week-num').value;
                const weekDay = document.getElementById('recurrence-week-day').value;
                return `${weekNum}-${weekDay}`;
            default:
                return '';
        }
    }

    function getRecurrenceLabel(type, value) {
        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        switch (type) {
            case 'weekly':
                return `æ¯é€±${dayNames[parseInt(value)]}æ›œæ—¥`;
            case 'biweekly':
                const parts = value.split(',');
                return `éš”é€±${dayNames[parseInt(parts[0])]}æ›œæ—¥`;
            case 'monthly_date':
                return `æ¯æœˆ${value}æ—¥`;
            case 'monthly_week':
                const weekParts = value.split('-');
                return `æ¯æœˆç¬¬${weekParts[0]}${dayNames[parseInt(weekParts[1])]}æ›œæ—¥`;
            default:
                return '';
        }
    }

    // ===== æ›´æ–° =====
    function updateOrder() {
        const form = {
            id: document.getElementById('edit-id').value,
            patient: document.getElementById('edit-patient').value,
            drug: document.getElementById('edit-drug').value,
            deadline: document.getElementById('edit-deadline').value,
            adminDate: document.getElementById('edit-admin').value,
            picName: currentUser.name,
            newPicEmail: document.getElementById('edit-pic-select').value,
            updaterEmail: currentUser.email
        };

        if (!confirm('ä¿®æ­£å†…å®¹ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;

        showLoading('ä¿å­˜ä¸­...');
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                alert('ä¿å­˜ã—ã¾ã—ãŸ');
                closeModal('edit-modal');
                refreshList();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + (res.message || res.details?.join('\n')));
                hideLoading();
            }
        }).withFailureHandler(e => {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
            hideLoading();
        }).updateOrderData(form);
    }

    // ===== v25.0: ã‚­ãƒ£ãƒ³ã‚»ãƒ«/å‰Šé™¤ãƒ•ãƒ­ãƒ¼ =====

    // ç¾åœ¨ç·¨é›†ä¸­ã®ç™ºæ³¨æƒ…å ±ã‚’ä¿æŒ
    let currentEditOrder = null;

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
    function confirmDelete() {
        const id = document.getElementById('edit-id').value;
        const patient = document.getElementById('edit-patient').value;
        const drug = document.getElementById('edit-drug').value;

        // ç¾åœ¨ã®ç™ºæ³¨ãŒå®šæœŸç™ºæ³¨ã‹ã©ã†ã‹ã‚’ç¢ºèª
        const order = allOrders.find(o => o.id === id);
        const isRecurring = order && order.isRecurring;

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
        document.getElementById('cancel-order-id').value = id;
        document.getElementById('cancel-patient-name').value = patient;
        document.getElementById('cancel-drug-name').value = drug;
        document.getElementById('cancel-is-recurring').value = isRecurring ? 'true' : 'false';

        // è¡¨ç¤ºåˆ‡æ›¿
        if (isRecurring) {
            document.getElementById('cancel-normal-message').style.display = 'none';
            document.getElementById('cancel-recurring-options').style.display = 'block';
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelector('input[name="cancel-type"][value="single"]').checked = true;
        } else {
            document.getElementById('cancel-normal-message').style.display = 'block';
            document.getElementById('cancel-recurring-options').style.display = 'none';
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        closeModal('edit-modal');
        document.getElementById('cancel-modal').style.display = 'flex';
    }

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Ÿè¡Œ
    function executeCancel() {
        const id = document.getElementById('cancel-order-id').value;
        const patient = document.getElementById('cancel-patient-name').value;
        const drug = document.getElementById('cancel-drug-name').value;
        const isRecurring = document.getElementById('cancel-is-recurring').value === 'true';

        if (isRecurring) {
            // å®šæœŸç™ºæ³¨ã®å ´åˆ: cancelOrder APIã‚’ä½¿ç”¨
            const cancelType = document.querySelector('input[name="cancel-type"]:checked').value;

            const confirmMsg = cancelType === 'series'
                ? 'ä»Šå¾Œã®å®šæœŸç™ºæ³¨ã‚’ã™ã¹ã¦åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'
                : 'ã“ã®äºˆå®šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ\nå®šæœŸç™ºæ³¨è‡ªä½“ã¯ç¶™ç¶šã•ã‚Œã¾ã™ã€‚';

            if (!confirm(confirmMsg)) return;

            closeModal('cancel-modal');
            showLoading('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­...');

            google.script.run.withSuccessHandler(res => {
                if (res.success) {
                    const msg = res.seriesCancelled
                        ? 'å®šæœŸç™ºæ³¨ã‚’åœæ­¢ã—ã¾ã—ãŸ'
                        : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ';
                    alert(msg);
                    refreshList();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
                    hideLoading();
                }
            }).withFailureHandler(e => {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
                hideLoading();
            }).cancelOrder(id, cancelType, currentUser.name);

        } else {
            // é€šå¸¸ç™ºæ³¨ã®å ´åˆ: ç‰©ç†å‰Šé™¤
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;

            closeModal('cancel-modal');
            showLoading('å‰Šé™¤ä¸­...');

            google.script.run.withSuccessHandler(res => {
                if (res.success) {
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                    refreshList();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
                    hideLoading();
                }
            }).withFailureHandler(e => {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
                hideLoading();
            }).deleteOrder(id, patient, drug, currentUser.name);
        }
    }

    // ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ =====
    function changeStatus(id, currentStatus) {
        const nextStatus = currentStatus === 'æœªç™ºæ³¨' ? 'ç™ºæ³¨æ¸ˆ' : 'ç´å“æ¸ˆ';
        let confirmPerson = '';

        if (nextStatus === 'ç´å“æ¸ˆ') {
            confirmPerson = prompt('ç´å“ã‚’ç¢ºèªã—ãŸã‚¹ã‚¿ãƒƒãƒ•ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', currentUser.name);
            if (!confirmPerson) return;
        }

        if (!confirm(`ã€Œ${nextStatus}ã€ã«å¤‰æ›´ã—ã€é€šçŸ¥ã‚’é€ã‚Šã¾ã™ã‹ï¼Ÿ`)) return;

        closeModal('edit-modal');
        showLoading('æ›´æ–°ä¸­...');

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                alert('æ›´æ–°å®Œäº†ï¼');
                refreshList();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
                hideLoading();
            }
        }).withFailureHandler(e => {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
            hideLoading();
        }).updateStatus(id, nextStatus, confirmPerson, currentUser.name);
    }

    // ===== ãƒªã‚¹ãƒˆæ›´æ–° =====
    function refreshList() {
        setTimeout(() => {
            google.script.run.withSuccessHandler(res => {
                if (res.orders) {
                    allOrders = res.orders;
                    applyFilters();
                }
                hideLoading();
            }).getLatestOrders();
        }, 1000);
    }

    // ===== ãƒ¢ãƒ¼ãƒ€ãƒ« =====
    function openRegisterModal() {
        document.getElementById('register-modal').style.display = 'flex';
    }

    function openEditModal(order) {
        document.getElementById('edit-id').value = order.id;
        document.getElementById('edit-status').value = order.status;
        document.getElementById('edit-patient').value = order.patient;
        document.getElementById('edit-drug').value = order.drug;
        document.getElementById('edit-deadline').value = order.deadline;
        document.getElementById('edit-admin').value = order.adminDate || '';
        document.getElementById('edit-pic-select').value = order.picEmail;

        const actionArea = document.getElementById('status-action-area');
        actionArea.innerHTML = '';

        if (order.status === 'æœªç™ºæ³¨') {
            actionArea.innerHTML = `
      <button class="status-btn" style="background:var(--ordered);" onclick="changeStatus('${order.id}', 'æœªç™ºæ³¨')">
        <span class="material-icons">local_shipping</span>ç™ºæ³¨æ¸ˆã«ã™ã‚‹
      </button>`;
        } else if (order.status === 'ç™ºæ³¨æ¸ˆ') {
            actionArea.innerHTML = `
      <button class="status-btn" style="background:var(--delivered);" onclick="changeStatus('${order.id}', 'ç™ºæ³¨æ¸ˆ')">
        <span class="material-icons">check_circle</span>ç´å“å®Œäº†
      </button>`;
        }

        document.getElementById('edit-modal').style.display = 'flex';
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° =====
    function showLoading(text) {
        const el = document.getElementById('app-loading');
        el.style.display = 'flex';
        // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼è¦ç´ ã‚’éè¡¨ç¤º
        const slideshow = el.querySelector('.loading-slideshow');
        if (slideshow) slideshow.style.display = 'none';
        const progressBox = el.querySelector('.progress-box');
        if (progressBox) progressBox.style.display = 'none';
        document.getElementById('loading-text').innerText = text;
    }

    function hideLoading() {
        document.getElementById('app-loading').style.display = 'none';
    }

    // ===== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ =====
    function switchPage(page) {
        currentPage = page;

        // ãƒŠãƒ“ã‚¢ã‚¤ãƒ†ãƒ ã®æ›´æ–°
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.page === page);
        });

        // ãƒšãƒ¼ã‚¸è¡¨ç¤ºåˆ‡æ›¿
        document.querySelectorAll('.page').forEach(p => {
            p.classList.toggle('active', p.id === 'page-' + page);
        });

        // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
        document.querySelector('.action-bar').style.display = page === 'list' ? 'block' : 'none';

        // å„ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–
        if (page === 'stats') {
            loadStatistics();
        } else if (page === 'calendar') {
            renderCalendar();
        } else if (page === 'history') {
            loadHistory();
        } else if (page === 'logs') {
            loadLogs();
        }
    }

    // ===== çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
    let statsChart = null;
    let pieChart = null;

    function loadStatistics() {
        const year = parseInt(document.getElementById('stats-year').value);
        showLoading('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...');

        google.script.run.withSuccessHandler(res => {
            hideLoading();
            if (res.success) {
                renderStatistics(res);
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
            }
        }).withFailureHandler(e => {
            hideLoading();
            alert('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e);
        }).getStatistics(year);
    }

    function renderStatistics(data) {
        const total = data.monthly.reduce((sum, m) => sum + m.count, 0);
        document.getElementById('stats-total').innerText = total;
        document.getElementById('stats-pending').innerText = data.byStatus['æœªç™ºæ³¨'] || 0;
        document.getElementById('stats-ordered').innerText = data.byStatus['ç™ºæ³¨æ¸ˆ'] || 0;
        document.getElementById('stats-overdue').innerText = data.overdueCount || 0;

        renderMonthlyChart(data.monthly);
        renderPicChart(data.byPic);
    }

    function renderMonthlyChart(monthly) {
        const ctx = document.getElementById('chart-monthly').getContext('2d');

        if (statsChart) statsChart.destroy();

        const labels = monthly.map(m => {
            const [year, month] = m.month.split('-');
            return `${parseInt(month)}æœˆ`;
        });
        const counts = monthly.map(m => m.count);

        statsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ç™ºæ³¨ä»¶æ•°',
                    data: counts,
                    backgroundColor: '#00796b',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function renderPicChart(byPic) {
        const ctx = document.getElementById('chart-pic').getContext('2d');

        if (pieChart) pieChart.destroy();

        const labels = Object.keys(byPic);
        const counts = Object.values(byPic);

        if (labels.length === 0) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            return;
        }

        const colors = [
            '#00796b', '#f57c00', '#d32f2f', '#388e3c', '#1976d2',
            '#7b1fa2', '#c2185b', '#0097a7', '#689f38', '#fbc02d'
        ];

        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: colors.slice(0, labels.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 8
                        }
                    }
                }
            }
        });
    }

    // ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ =====
    let calendarDate = new Date();

    function renderCalendar() {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();

        // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
        document.getElementById('calendar-title').innerText = `${year}å¹´${month + 1}æœˆ`;

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        // å‰æœˆã®æ—¥ã‚’åŸ‹ã‚ã‚‹
        const startDayOfWeek = firstDay.getDay();
        const prevMonthLastDay = new Date(year, month, 0).getDate();

        for (let i = startDayOfWeek - 1; i >= 0; i--) {
            const day = prevMonthLastDay - i;
            const dateStr = formatDateForCal(new Date(year, month - 1, day));
            grid.appendChild(createDayCell(day, dateStr, true, getDayOfWeek(year, month - 1, day)));
        }

        // å½“æœˆã®æ—¥
        const today = new Date();
        const todayStr = formatDateForCal(today);

        for (let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = formatDateForCal(new Date(year, month, day));
            const isToday = dateStr === todayStr;
            const dayOfWeek = getDayOfWeek(year, month, day);
            grid.appendChild(createDayCell(day, dateStr, false, dayOfWeek, isToday));
        }

        // ç¿Œæœˆã®æ—¥ã‚’åŸ‹ã‚ã‚‹
        const totalCells = grid.children.length;
        const remainingCells = 42 - totalCells; // 6è¡Œ Ã— 7æ—¥

        for (let day = 1; day <= remainingCells; day++) {
            const dateStr = formatDateForCal(new Date(year, month + 1, day));
            grid.appendChild(createDayCell(day, dateStr, true, getDayOfWeek(year, month + 1, day)));
        }
    }

    function createDayCell(day, dateStr, isOtherMonth, dayOfWeek, isToday = false) {
        const cell = document.createElement('div');
        cell.className = 'cal-day';

        if (isOtherMonth) cell.classList.add('other-month');
        if (isToday) cell.classList.add('today');
        if (dayOfWeek === 0) cell.classList.add('sun');
        if (dayOfWeek === 6) cell.classList.add('sat');

        // æ—¥ä»˜ç•ªå·
        const dayNum = document.createElement('div');
        dayNum.className = 'day-number';
        dayNum.innerText = day;
        cell.appendChild(dayNum);

        // ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ã®ãƒ‰ãƒƒãƒˆè¡¨ç¤º
        const ordersOnDay = allOrders.filter(o => o.deadline === dateStr);
        if (ordersOnDay.length > 0) {
            const dotsContainer = document.createElement('div');
            dotsContainer.className = 'day-dots';

            // æœ€å¤§5å€‹ã¾ã§è¡¨ç¤º
            ordersOnDay.slice(0, 5).forEach(o => {
                const dot = document.createElement('div');
                dot.className = 'day-dot ' + (o.status === 'æœªç™ºæ³¨' ? 'pending' : 'ordered');
                dotsContainer.appendChild(dot);
            });

            cell.appendChild(dotsContainer);
        }

        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        cell.onclick = () => showDayPopover(dateStr, ordersOnDay);

        return cell;
    }

    function formatDateForCal(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function getDayOfWeek(year, month, day) {
        return new Date(year, month, day).getDay();
    }

    function changeMonth(delta) {
        calendarDate.setMonth(calendarDate.getMonth() + delta);
        renderCalendar();
    }

    function goToToday() {
        calendarDate = new Date();
        renderCalendar();
    }

    // ===== æ—¥ä»˜ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ =====
    function showDayPopover(dateStr, orders) {
        // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã‚’å‰Šé™¤
        closeDayPopover();

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        const overlay = document.createElement('div');
        overlay.className = 'popover-overlay show';
        overlay.onclick = closeDayPopover;
        document.body.appendChild(overlay);

        // ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼
        const popover = document.createElement('div');
        popover.className = 'day-popover show';
        popover.id = 'day-popover';

        // æ—¥ä»˜ã‚’æ•´å½¢
        const dateObj = new Date(dateStr);
        const displayDate = `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥`;

        let html = `
            <div class="popover-header">
                <h4>ğŸ“… ${displayDate}ã®ç™ºæ³¨</h4>
                <button class="popover-close" onclick="closeDayPopover()">
                    <span class="material-icons">close</span>
                </button>
            </div>
        `;

        // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        html += `
            <button class="popover-add-btn" onclick="openRegisterFromCalendar('${dateStr}')">
                <span class="material-icons">add_circle</span>
                ã“ã®æ—¥ã«æ–°è¦ç™»éŒ²
            </button>
        `;

        if (orders.length === 0) {
            html += '<div class="popover-empty">ã“ã®æ—¥ã®ç™ºæ³¨ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
        } else {
            orders.forEach(o => {
                const statusClass = o.status === 'æœªç™ºæ³¨' ? 'pending' : 'ordered';
                const dataJson = JSON.stringify(o).replace(/"/g, '&quot;');
                html += `
                    <div class="popover-item ${statusClass}" onclick="openEditFromPopover(${dataJson})">
                        <div class="popover-item-main">
                            <div class="popover-item-drug">ğŸ’Š ${o.drug || '(è–¬å‰¤åãªã—)'}</div>
                            <div class="popover-item-patient">${o.patient} æ§˜ / ${o.pic}</div>
                        </div>
                        <span class="status-badge ${statusClass}">${o.status}</span>
                    </div>
                `;
            });
        }

        popover.innerHTML = html;
        document.body.appendChild(popover);
    }

    function closeDayPopover() {
        const popover = document.getElementById('day-popover');
        if (popover) popover.remove();

        const overlay = document.querySelector('.popover-overlay');
        if (overlay) overlay.remove();
    }

    function openEditFromPopover(order) {
        closeDayPopover();
        openEditModal(order);
    }

    function openRegisterFromCalendar(dateStr) {
        closeDayPopover();

        // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        document.getElementById('register-modal').style.display = 'flex';

        // ç™ºæ³¨æœŸé™æ—¥ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('deadline').value = dateStr;
    }

    // ===== æœŸé™ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ =====
    function getCountdown(deadlineStr) {
        if (!deadlineStr) return { text: '', class: '' };

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const deadline = new Date(deadlineStr);
        deadline.setHours(0, 0, 0, 0);

        const diffTime = deadline - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) {
            return { text: `${Math.abs(diffDays)}æ—¥è¶…é`, class: 'overdue' };
        } else if (diffDays === 0) {
            return { text: 'ä»Šæ—¥', class: 'overdue' };
        } else if (diffDays === 1) {
            return { text: 'æ˜æ—¥', class: 'urgent' };
        } else if (diffDays <= 3) {
            return { text: `ã‚ã¨${diffDays}æ—¥`, class: 'urgent' };
        } else if (diffDays <= 7) {
            return { text: `ã‚ã¨${diffDays}æ—¥`, class: 'normal' };
        } else {
            return { text: '', class: '' };
        }
    }

    // ===== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ =====
    let isDarkMode = localStorage.getItem('darkMode') === 'true';

    // åˆæœŸåŒ–æ™‚ã«ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰é©ç”¨
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
        setTimeout(() => {
            const icon = document.getElementById('dark-mode-icon');
            if (icon) icon.innerText = 'light_mode';
        }, 100);
    }

    function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        localStorage.setItem('darkMode', isDarkMode);

        const icon = document.getElementById('dark-mode-icon');
        icon.innerText = isDarkMode ? 'light_mode' : 'dark_mode';
    }

    // ===== å±¥æ­´ãƒšãƒ¼ã‚¸ =====
    let historyData = [];

    function loadHistory() {
        const days = parseInt(document.getElementById('history-period').value);
        showLoading('å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...');

        google.script.run.withSuccessHandler(res => {
            hideLoading();
            if (res.success) {
                historyData = res.orders || [];
                renderHistory();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
            }
        }).withFailureHandler(e => {
            hideLoading();
            alert('å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e);
        }).getDeliveredOrders(days);
    }

    function renderHistory() {
        const container = document.getElementById('history-list');

        if (!historyData || historyData.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons">check_circle</span>
                    <p>ã“ã®æœŸé–“ã®ç´å“æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>`;
            return;
        }

        let html = '';
        historyData.forEach(o => {
            html += `
                <div class="history-card">
                    <div class="card-header">
                        <div class="drug-name">ğŸ’Š ${o.drug || '(è–¬å‰¤åãªã—)'}</div>
                        <span class="delivered-badge">ç´å“æ¸ˆ</span>
                    </div>
                    <div class="info-row">
                        <span class="material-icons">person</span>
                        ${o.patient} æ§˜
                    </div>
                    <div class="info-row">
                        <span class="material-icons">check_circle</span>
                        ç´å“æ—¥: ${o.deliveredDate || '-'}
                    </div>
                    <div class="info-row">
                        <span class="material-icons">badge</span>
                        ç¢ºèªè€…: ${o.confirmedBy || '-'}
                    </div>
                </div>`;
        });

        container.innerHTML = html;
    }

    // ===== æ“ä½œãƒ­ã‚°æ©Ÿèƒ½ =====
    let allLogs = [];
    let filteredLogs = [];

    function loadLogs() {
        const days = parseInt(document.getElementById('log-period').value);
        showLoading('æ“ä½œãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...');

        google.script.run.withSuccessHandler(res => {
            hideLoading();
            if (res.success) {
                allLogs = res.logs || [];
                populateLogUserFilter();
                filterLogs();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
            }
        }).withFailureHandler(e => {
            hideLoading();
            alert('ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e);
        }).getOperationLogs(days);
    }

    function populateLogUserFilter() {
        const userSelect = document.getElementById('log-user');
        const users = [...new Set(allLogs.map(l => l.operator).filter(u => u))];

        userSelect.innerHTML = '<option value="">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>';
        users.forEach(u => {
            userSelect.innerHTML += `<option value="${u}">${u}</option>`;
        });
    }

    function filterLogs() {
        const actionFilter = document.getElementById('log-action').value;
        const userFilter = document.getElementById('log-user').value;

        filteredLogs = allLogs.filter(l => {
            if (actionFilter && !l.action.includes(actionFilter)) return false;
            if (userFilter && l.operator !== userFilter) return false;
            return true;
        });

        renderLogsSummary();
        renderLogs();
    }

    function renderLogsSummary() {
        const container = document.getElementById('logs-summary');

        // æ“ä½œç¨®åˆ¥ã®ã‚«ã‚¦ãƒ³ãƒˆ
        const counts = {
            register: 0,
            update: 0,
            delete: 0,
            status: 0
        };

        filteredLogs.forEach(l => {
            if (l.action.includes('ç™»éŒ²')) counts.register++;
            else if (l.action.includes('æ›´æ–°') || l.action.includes('å¤‰æ›´')) counts.update++;
            else if (l.action.includes('å‰Šé™¤')) counts.delete++;
            else if (l.action.includes('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹')) counts.status++;
        });

        container.innerHTML = `
            <div class="log-stat">
                <div class="log-stat-value">${filteredLogs.length}</div>
                <div class="log-stat-label">ç·æ“ä½œæ•°</div>
            </div>
            <div class="log-stat">
                <div class="log-stat-value" style="color:var(--primary)">${counts.register}</div>
                <div class="log-stat-label">ç™»éŒ²</div>
            </div>
            <div class="log-stat">
                <div class="log-stat-value" style="color:var(--ordered)">${counts.update}</div>
                <div class="log-stat-label">æ›´æ–°</div>
            </div>
            <div class="log-stat">
                <div class="log-stat-value" style="color:var(--accent)">${counts.delete}</div>
                <div class="log-stat-label">å‰Šé™¤</div>
            </div>
        `;
    }

    function renderLogs() {
        const container = document.getElementById('logs-list');

        if (!filteredLogs || filteredLogs.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons">history</span>
                    <p>ã“ã®æœŸé–“ã®æ“ä½œãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>`;
            return;
        }

        let html = '';
        filteredLogs.forEach(l => {
            const iconInfo = getLogIconInfo(l.action);

            html += `
                <div class="log-item">
                    <div class="log-icon ${iconInfo.class}">${iconInfo.icon}</div>
                    <div class="log-content">
                        <div class="log-action">${l.action}</div>
                        <div class="log-details">${l.details || ''}</div>
                        <div class="log-meta">
                            <span><span class="material-icons">schedule</span>${l.timestamp}</span>
                            <span><span class="material-icons">person</span>${l.operator || '-'}</span>
                        </div>
                    </div>
                </div>`;
        });

        container.innerHTML = html;
    }

    function getLogIconInfo(action) {
        if (action.includes('ç™»éŒ²')) return { icon: 'â•', class: 'register' };
        if (action.includes('å‰Šé™¤')) return { icon: 'ğŸ—‘ï¸', class: 'delete' };
        if (action.includes('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹')) return { icon: 'ğŸ”„', class: 'status' };
        if (action.includes('æ‹…å½“è€…')) return { icon: 'ğŸ‘¤', class: 'pic' };
        return { icon: 'âœï¸', class: 'update' };
    }

    // ===== v26.0: é€šçŸ¥è¨­å®š =====
    let currentUserSettings = { notifySetting: 'all' };

    function openSettingsModal() {
        // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—ã—ã¦ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã«åæ˜ 
        const setting = currentUserSettings.notifySetting || 'all';
        const radio = document.querySelector(`input[name="notify-setting"][value="${setting}"]`);
        if (radio) radio.checked = true;

        document.getElementById('settings-modal').style.display = 'flex';
    }

    function saveSettings() {
        const selected = document.querySelector('input[name="notify-setting"]:checked');
        if (!selected) {
            alert('è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        const newSetting = selected.value;
        showLoading('è¨­å®šã‚’ä¿å­˜ä¸­...');

        google.script.run.withSuccessHandler(res => {
            hideLoading();
            if (res.success) {
                currentUserSettings.notifySetting = newSetting;
                alert('é€šçŸ¥è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                closeModal('settings-modal');
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
            }
        }).withFailureHandler(e => {
            hideLoading();
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
        }).updateStaffSettings(currentUser.email, { notifySetting: newSetting });
    }

    // åˆæœŸåŒ–æ™‚ã«è¨­å®šã‚’èª­ã¿è¾¼ã‚€
    function loadUserSettings() {
        google.script.run.withSuccessHandler(res => {
            if (res.success && res.settings) {
                currentUserSettings = res.settings;
            }
        }).withFailureHandler(e => {
            console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        }).getStaffSettings(currentUser.email);
    }

    // ===== v26.0: ãƒ¢ãƒã‚¤ãƒ«ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ =====
    let touchStartX = 0;
    let touchEndX = 0;
    let swipedCard = null;

    function initSwipeActions() {
        const orderList = document.getElementById('order-list');
        if (!orderList) return;

        orderList.addEventListener('touchstart', handleTouchStart, { passive: true });
        orderList.addEventListener('touchmove', handleTouchMove, { passive: true });
        orderList.addEventListener('touchend', handleTouchEnd);
    }

    function handleTouchStart(e) {
        const card = e.target.closest('.order-card');
        if (!card) return;

        touchStartX = e.changedTouches[0].screenX;
        swipedCard = card;
    }

    function handleTouchMove(e) {
        if (!swipedCard) return;
        touchEndX = e.changedTouches[0].screenX;
    }

    function handleTouchEnd(e) {
        if (!swipedCard) return;

        const diffX = touchStartX - touchEndX;
        const threshold = 80; // ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šã®é–¾å€¤

        // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—: ç™ºæ³¨æ¸ˆã«ã™ã‚‹
        if (diffX > threshold) {
            showSwipeAction(swipedCard, 'ordered');
        }
        // å³ã‚¹ãƒ¯ã‚¤ãƒ—: å‰Šé™¤
        else if (diffX < -threshold) {
            showSwipeAction(swipedCard, 'delete');
        }

        // ãƒªã‚»ãƒƒãƒˆ
        touchStartX = 0;
        touchEndX = 0;
        swipedCard = null;
    }

    function showSwipeAction(card, actionType) {
        const orderId = card.dataset.id;
        const order = allOrders.find(o => o.id === orderId);
        if (!order) return;

        // æ—¢å­˜ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
        const existingActions = card.querySelector('.swipe-actions');
        if (existingActions) existingActions.remove();

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'swipe-actions';

        if (actionType === 'ordered' && order.status === 'æœªç™ºæ³¨') {
            actionsDiv.innerHTML = `
                <button class="swipe-btn ordered" onclick="quickChangeStatus('${orderId}')">
                    <span class="material-icons">local_shipping</span>ç™ºæ³¨æ¸ˆ
                </button>
                <button class="swipe-btn cancel" onclick="hideSwipeActions(this)">
                    <span class="material-icons">close</span>
                </button>
            `;
        } else if (actionType === 'delete') {
            actionsDiv.innerHTML = `
                <button class="swipe-btn delete" onclick="quickDelete('${orderId}')">
                    <span class="material-icons">delete</span>å‰Šé™¤
                </button>
                <button class="swipe-btn cancel" onclick="hideSwipeActions(this)">
                    <span class="material-icons">close</span>
                </button>
            `;
        }

        card.appendChild(actionsDiv);

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        setTimeout(() => actionsDiv.classList.add('show'), 10);
    }

    function hideSwipeActions(btn) {
        const actionsDiv = btn.closest('.swipe-actions');
        if (actionsDiv) {
            actionsDiv.classList.remove('show');
            setTimeout(() => actionsDiv.remove(), 200);
        }
    }

    function quickChangeStatus(orderId) {
        if (!confirm('ã€Œç™ºæ³¨æ¸ˆã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) return;

        showLoading('æ›´æ–°ä¸­...');
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                refreshList();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
                hideLoading();
            }
        }).withFailureHandler(e => {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
            hideLoading();
        }).updateStatus(orderId, 'ç™ºæ³¨æ¸ˆ', '', currentUser.name);
    }

    function quickDelete(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) return;

        if (!confirm('ã“ã®ç™ºæ³¨ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        showLoading('å‰Šé™¤ä¸­...');
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                refreshList();
            } else {
                alert('ã‚¨ãƒ©ãƒ¼: ' + res.message);
                hideLoading();
            }
        }).withFailureHandler(e => {
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e);
            hideLoading();
        }).deleteOrder(orderId, order.patient, order.drug, currentUser.name);
    }

    // åˆæœŸåŒ–æ™‚ã«ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setTimeout(() => {
        initSwipeActions();
        loadUserSettings();
    }, 1000);
</script>