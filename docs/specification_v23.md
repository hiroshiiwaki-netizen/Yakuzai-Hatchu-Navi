# 薬剤発注ナビ 詳細仕様書

**バージョン**: v23.0 (患者検索修正版)  
**最終更新**: 2026-01-02  
**ステータス**: 本番稼働中

---

## 1. システム概要

### 1.1 目的
薬剤の発注管理を効率化し、発注漏れを防止するWebアプリケーション。

### 1.2 基本情報

| 項目 | 内容 |
|------|------|
| アプリ名 | 薬剤発注ナビ |
| プラットフォーム | Google Apps Script (GAS) Webアプリ |
| 対象ユーザー | nhw.jp ドメインのスタッフ |
| 対応デバイス | PC / スマートフォン（レスポンシブ対応） |

---

## 2. 外部連携

### 2.1 Google カレンダー
- **用途**: 発注予定のイベント管理
- **カレンダーID**: `c_fbaa34d73eb9d9fada0ce4f25fcaefa4bcc3ba7626d6194d50c1778fef9d0244@group.calendar.google.com`
- **動作**:
  - 新規登録時: 終日イベント作成、担当者をゲスト招待
  - ステータス変更時: イベントタイトル更新
  - 削除時: イベント削除

### 2.2 Google Chat Webhook
- **用途**: 各種通知の自動送信
- **URL**: `https://chat.googleapis.com/v1/spaces/AAQAdWFuXFM/...`
- **通知タイミング**:
  - 🟢 新規登録時
  - ✏️ 内容修正時
  - 🟠 発注完了時
  - 🔵 納品確認時
  - 🗑️ 削除時
  - 🟡🟠🔴 定期リマインド

### 2.3 スプレッドシート連携

| マスター名 | スプレッドシートID | カラム構成 | 使用カラム |
|-----------|-------------------|-----------|-----------|
| スタッフマスター | `1wR-ht-2MFrf2NQFPef2Xol3iQ7qIwXsQv_9T2IImoTM` | A:Email, B:氏名, C:職種, D:所属デポ, E:クロスログID | A, B |
| 患者マスター | `1zD7lIxWrMEzma9GDP0Yltp_YG56pOxVUsYYPNJ3a-nE` | A:homisID, B:TukusiID, C:氏名, D:カナ, E:生年月日, F:性別, G:郵便番号, H:住所, I:電話番号 | C, D |
| データDB | `1ffuhDYZSts3u6YN0vzQX_CwVXWDqRLD2zn3vkFbqtxQ` | シート1 | - |

---

## 3. データ構造

### 3.1 データDB カラム定義

| 列 | カラム名 | データ型 | 必須 | 説明 |
|----|---------|---------|-----|------|
| A | ID | 文字列 | ○ | UUID形式の一意識別子 |
| B | ステータス | 文字列 | ○ | 未発注/発注済/納品済 |
| C | 患者名 | 文字列 | ○ | 患者の漢字氏名 |
| D | 薬剤名 | 文字列 | △ | 発注する薬剤名 |
| E | 発注期限日 | 日付 | ○ | 発注すべき期限 |
| F | 投与予定日 | 日付 | - | 患者への投与予定日 |
| G | 担当者メール | 文字列 | ○ | 担当スタッフのメールアドレス |
| H | イベントID | 文字列 | ○ | GoogleカレンダーのイベントID |
| I | 登録日時 | 日時 | ○ | データ登録日時 |
| J | 納品確認日時 | 日時 | - | 納品を確認した日時 |
| K | 納品確認者 | 文字列 | - | 納品を確認したスタッフ名 |

### 3.2 ステータス遷移

```
未発注 ─→ 発注済 ─→ 納品済
```

| 遷移 | トリガー | 処理 |
|------|---------|------|
| 新規→未発注 | 登録ボタン | カレンダー作成、Chat通知 |
| 未発注→発注済 | 「発注済にする」ボタン | Chat通知 |
| 発注済→納品済 | 「納品完了」ボタン | 確認者・日時記録、Chat通知 |

---

## 4. 機能仕様

### 4.1 認証機能 (step1_SimpleAuth)

**処理フロー**:
1. `Session.getActiveUser().getEmail()` でログインユーザーを取得
2. ドメイン検証 (`nhw.jp` のみ許可)
3. 認証結果を返却

**レスポンス**:
```javascript
// 成功時
{ success: true, email: "user@nhw.jp" }

// 失敗時
{ success: false, message: "権限エラー: nhw.jp のアカウントのみ利用可能です。" }
```

### 4.2 マスターデータ取得 (step2_GetMasters)

**処理フロー**:
1. スタッフマスターからメール・名前を取得 (上限1000件)
2. 患者マスターからC列(漢字)・D列(カナ)を全件取得
3. 両マスターを返却

**レスポンス**:
```javascript
{
  success: true,
  staff: [{ email: "user@nhw.jp", name: "山田太郎" }, ...],
  patients: [{ name: "鈴木一郎", kana: "スズキイチロウ" }, ...]
}
```

### 4.3 発注リスト取得 (step3_GetOrders)

**処理フロー**:
1. データDBから全件取得 (上限1000件)
2. `納品済` を除外
3. 発注期限日で昇順ソート
4. 担当者メールから名前を解決

**レスポンス**:
```javascript
{
  success: true,
  orders: [{
    id: "uuid-xxx",
    status: "未発注",
    patient: "鈴木一郎",
    drug: "〇〇注射液",
    deadline: "2026-01-10",
    adminDate: "2026-01-15",
    pic: "山田太郎",
    picEmail: "user@nhw.jp",
    eventId: "xxx"
  }, ...]
}
```

### 4.4 新規登録 (registerOrder)

**入力パラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|---|-----|------|
| patient | string | ○ | 患者名 |
| drug | string | △ | 薬剤名 |
| deadline | string | ○ | 発注期限日 (yyyy-MM-dd) |
| adminDate | string | - | 投与予定日 (yyyy-MM-dd) |
| picEmail | string | ○ | 担当者メール |
| picName | string | ○ | 担当者名 |

**処理フロー**:
1. Googleカレンダーに終日イベント作成
2. 担当者をゲストとして招待
3. データDBに新規行追加
4. Google Chatに通知送信

### 4.5 データ編集 (updateOrderData)

**入力パラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|---|-----|------|
| id | string | ○ | 対象データのID |
| patient | string | ○ | 患者名 |
| drug | string | △ | 薬剤名 |
| deadline | string | ○ | 発注期限日 |
| adminDate | string | - | 投与予定日 |
| picName | string | ○ | 担当者名 (通知用) |

**処理フロー**:
1. IDで対象行を検索
2. 各カラムを更新
3. カレンダーイベントのタイトル・説明を更新
4. Google Chatに通知送信

### 4.6 データ削除 (deleteOrder)

**入力パラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|---|-----|------|
| id | string | ○ | 対象データのID |
| patientName | string | ○ | 患者名 (通知用) |
| drugName | string | ○ | 薬剤名 (通知用) |
| deleterName | string | ○ | 削除実行者名 |

**処理フロー**:
1. IDで対象行を検索
2. カレンダーイベントを削除
3. スプレッドシートから行を削除
4. Google Chatに通知送信

### 4.7 ステータス更新 (updateStatus)

**入力パラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|---|-----|------|
| id | string | ○ | 対象データのID |
| newStatus | string | ○ | 新ステータス |
| confirmPerson | string | △ | 納品確認者 (納品済時のみ必須) |
| updaterName | string | ○ | 更新実行者名 |

**処理フロー**:
1. IDで対象行を検索
2. ステータスカラムを更新
3. 納品済の場合: 確認日時・確認者を記録
4. カレンダーイベントのタイトルを更新
5. Google Chatに通知送信

### 4.8 定期リマインド (hourlyAlertTask)

**トリガー**: 毎時実行 (外部設定)
**停止時間**: 22:00〜6:00

**通知条件**:
| 条件 | 通知時刻 | アイコン | メッセージ |
|------|---------|---------|----------|
| 期限1〜3日前 | 9:00 | 🟡 | リマインド |
| 期限当日 | 9:00, 12:00, 16:00 | 🟠 | 本日発注日 |
| 期限超過 | 毎時 | 🔴 | 緊急：発注超過 |

---

## 5. UI仕様

### 5.1 画面構成

```
┌─────────────────────────────────────┐
│ ヘッダー (アプリ名 | ユーザー情報)   │
├─────────────────────────────────────┤
│ 発注・納品待ちリスト                 │
│ ┌─────────────────────────────────┐ │
│ │ カード1                         │ │
│ │ 💊 薬剤名          [未発注]    │ │
│ │ 👤 患者名 様        期限:日付   │ │
│ │ 担当: 担当者名                  │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ カード2...                      │ │
│ └─────────────────────────────────┘ │
│                              [＋FAB] │
└─────────────────────────────────────┘
```

### 5.2 モーダル

#### 新規登録モーダル
- 患者名 (サジェスト付き)
- 薬剤名
- 発注期限日 (必須)
- 投与予定日
- 担当者 (読み取り専用、ログインユーザー)

#### 詳細・編集モーダル
- 患者名 (サジェスト付き)
- 薬剤名
- 発注期限日
- 投与予定日
- 担当者 (読み取り専用)
- ステータス変更ボタン
- 内容修正ボタン
- 削除ボタン

### 5.3 患者検索サジェスト

**動作**:
1. 入力文字を含む患者をフィルタリング
2. 漢字氏名・カナ両方で検索
3. 最大15件表示
4. 選択で入力欄に反映

---

## 6. ファイル構成 (v23.0)

```
薬剤発注ナビ/
├── SRC/
│   ├── code.gs      # サーバーサイドロジック全体
│   └── index.html   # クライアントサイド (HTML/CSS/JS)
└── docs/
    └── specification_v23.md  # 本仕様書
```

---

## 7. 制限事項・既知の問題

### 7.1 制限事項
- 取得件数: スタッフ1000件、発注データ1000件が上限
- ドメイン制限: nhw.jp のみアクセス可能
- 担当者変更: 登録後の担当者変更不可

### 7.2 既知の問題
- エラーハンドリングが不十分（エラー握りつぶし）
- バリデーション不足
- フィルター・検索機能なし

---

## 8. バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v23.0 | 2026-01-02 | 患者マスターのC列(漢字)・D列(カナ)読み込み修正 |

---

## 9. 次期バージョン予定 (v24.0)

- ファイル分割による保守性向上
- エラーハンドリング強化
- 入力バリデーション追加
- 担当者変更機能
- キャッシュ機能
- フィルター・検索機能
- 操作ログ機能
- 一括操作
- 統計ダッシュボード
