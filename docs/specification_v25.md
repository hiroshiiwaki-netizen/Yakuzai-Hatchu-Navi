# 薬剤発注ナビ 詳細仕様書

**バージョン**: v25.0 (定期発注対応版)  
**最終更新**: 2026-01-16  
**ステータス**: 📝 計画中

---

## 1. システム概要

### 1.1 目的
薬剤の発注管理を効率化し、発注漏れを防止するWebアプリケーション。

### 1.2 v25.0 での追加機能
- **定期発注機能**: 毎週・毎月などのパターンでの自動発注登録
- **キャンセル種別**: 「今回のみキャンセル」と「定期発注全体の停止」の選択
- **関連DB変更**: 定期設定情報の保持

---

## 2. ファイル構成（変更なし）

| ファイル | 役割 | 行数目安 |
|---------|------|---------|
| Config.gs | 設定定数・ヘルパー関数 | 80行 |
| Validator.gs | 入力バリデーション | 130行 (+10) |
| Logger.gs | 操作ログ記録・取得 | 80行 |
| Masters.gs | マスターデータ取得 | 140行 |
| Notify.gs | 各種通知・定期リマインド | 160行 |
| Orders.gs | 発注CRUD・定期生成ロジック | 550行 (+100) |
| Code.gs | エントリーポイント・トリガー | 80行 (+20) |
| styles.html | CSS | 350行 |
| scripts.html | JavaScript | 450行 (+50) |
| index.html | HTML | 200行 (+20) |

---

## 3. データベース変更点 (v25.0)

### 3.1 データDB カラム構成（変更あり）
既存のA～K列に加え、L～P列を追加する。

| 列 | カラム名 | 型 | 説明 |
|----|---------|---|-----|
| A | ID | UUID | |
| B | ステータス | 文字列 | `Template`(定期親)を追加 |
| C | 患者名 | 文字列 | |
| D | 薬剤名 | 文字列 | |
| E | 発注期限日 | 日付 | 定期親の場合は次回生成基準日 |
| F | 投与予定日 | 日付 | |
| G | 担当者メール | 文字列 | |
| H | イベントID | 文字列 | |
| I | 登録日時 | 日時 | |
| J | 納品確認日時 | 日時 | |
| K | 納品確認者 | 文字列 | |
| **L** | **RECURRENCE_TYPE** | 文字列 | `weekly`, `monthly_date`, `monthly_week`, `biweekly` |
| **M** | **RECURRENCE_VALUE** | 文字列 | 曜日(0-6), 日(1-31), 第N週-曜日(2-4など) |
| **N** | **PARENT_ORDER_ID** | 文字列 | 定期発注の親ID（TemplateのID） |
| **O** | **IS_CANCELLED** | 真偽値 | 個別キャンセルフラグ |
| **P** | **SERIES_CANCELLED** | 真偽値 | 定期全体の停止フラグ |

---

## 4. 機能仕様 (v25.0 追加・変更分)

### 4.1 定期発注登録 (registerRecurringOrder)
- **定期親レコードの作成**:
  - ステータスを `Template` として保存。
  - 発注リストには表示しない。
  - `RECURRENCE_TYPE`, `RECURRENCE_VALUE` を保存。
- **初回レコードの生成**:
  - 登録直後に直近の1回分（または指定期間分）の通常レコード（ステータス `未発注`）を生成する。
  - 生成されたレコードの `PARENT_ORDER_ID` に親IDをセットする。

### 4.2 定期発注自動生成 (generateRecurringOrders)
- **日次トリガー**で実行。
- `Template` ステータスのレコードを全件走査。
- `SERIES_CANCELLED` が `TRUE` のものはスキップ。
- `発注期限日` から設定期間（例: 向こう30日分）に含まれる予定日を計算。
- 既に生成済み（`PARENT_ORDER_ID` と `発注期限日` が一致）のレコードが存在しなければ新規作成。
- 親レコードの `発注期限日` を更新して次回計算の基準にする。

### 4.3 定期発注キャンセル (cancelOrder)
- ユーザーがキャンセルを選択した際、対象が定期発注（`PARENT_ORDER_ID`あり）の場合、モーダルで選択肢を表示。
1. **この回のみキャンセル**:
   - 対象レコードの状態を `キャンセル` (または論理削除) に更新。
   - `IS_CANCELLED = TRUE` をセット。
2. **今後すべてキャンセル**:
   - 対象レコードをキャンセル。
   - 親レコード（`PARENT_ORDER_ID`で検索）の `SERIES_CANCELLED` を `TRUE` に更新。
   - 以降の自動生成を停止する。

---

## 5. UI仕様 (v25.0 追加分)

### 5.1 新規登録モーダル
- **頻度設定UI**:
  - ラジオボタン: `単発` / `定期`
  - 定期選択時:
    - パターン選択: `毎週`, `隔週`, `毎月(日付)`, `毎月(曜日)`
    - 値入力: 曜日選択プルダウンや日付入力

### 5.2 キャンセル確認モーダル
- 通常の確認に加え、定期発注の場合はラジオボタンを表示。
  - `◯ この予定のみキャンセル`
  - `◯ 今後の定期発注をすべて停止`

---

## 6. 定期パターン定義

| 内部値 | UI表示 | RECURRENCE_VALUE 例 | 備考 |
|--------|-------|-------------------|------|
| `weekly` | 毎週 | `3` (水曜日) | 0=日, 1=月... |
| `biweekly` | 隔週 | `1,2026-01-01` | 曜日,基準日 |
| `monthly_date` | 毎月(日付) | `15` | 毎月15日 |
| `monthly_week` | 毎月(曜日) | `2-3` | 第2水曜日 |

---

## 7. デプロイ・移行手順

1. **DBスキーマ更新**: データDBスプレッドシートに L〜P列を追加。
2. **スクリプト更新**: ソースコードをv25.0仕様に更新。
3. **トリガー設定**: `generateRecurringOrders` を日次実行（例: 深夜1時）に設定。
