# 薬剤発注ナビ v25.0 実装計画書

**概要**: 定期発注機能およびキャンセル種別選択機能の実装。スプレッドシートへの列追加と、GAS側のロジック更新を行う。

## User Review Required
> [!IMPORTANT]
> **データベース構造の変更**: スプレッドシート（DataDB）に5つの新しい列を追加します。既存のプログラム（v24.0以前）への影響はありませんが、v25.0稼働には必須となります。

---

## Proposed Changes

### 1. データベース準備 (手動/ツール)
- [ ] **スプレッドシート列追加**
  - 対象: `DataDB` シート
  - 追加列:
    - L列: `RECURRENCE_TYPE`
    - M列: `RECURRENCE_VALUE`
    - N列: `PARENT_ORDER_ID`
    - O列: `IS_CANCELLED`
    - P列: `SERIES_CANCELLED`

### 2. バックエンド実装 (GAS)

#### [MODIFY] src/Config.gs
- 定期パターン定義定数の追加 (`RECURRENCE_PATTERNS`)
- 列インデックス定数の更新

#### [MODIFY] src/Orders.gs
- **新規登録 (`registerOrder`) の改修**:
  - 定期設定がある場合、親レコード（Template）を作成するロジック追加。
  - 初回の子レコードを作成するロジック追加。
- **キャンセル (`deleteOrder/updateStatus`) の改修**:
  - キャンセル種別引数の受け取り。
  - `SERIES_CANCELLED` フラグ更新ロジックの追加。
- **[NEW] 自動生成関数 (`generateRecurringOrders`)**:
  - 親レコードを検索し、未来の発注レコードを生成するバッチ処理。

#### [MODIFY] src/Code.gs
- 日次トリガー用エントリポイント `dailyRecurrenceCheck` の追加。

### 3. フロントエンド実装

#### [MODIFY] src/index.html / src/scripts.html
- **登録モーダル**:
  - 「定期発注」チェックボックスと詳細設定UI（曜日選択など）の追加。
- **リスト表示**:
  - 定期発注アイテムにアイコン（🔄）を表示。
- **削除/キャンセルモーダル**:
  - 定期アイテム削除時に「今回のみ」「全停止」の選択肢を表示する条件分岐。

#### [MODIFY] src/styles.html
- 定期設定UI用のスタイル追加。

---

## Verification Plan

### 自動生成の検証
1. **トリガー実行テスト**:
   - `generateRecurringOrders` を手動実行し、翌週分のレコードが生成されるか確認。
2. **パターン網羅テスト**:
   - 毎週、毎月(日付)、毎月(曜日) の各パターンで正しく日付計算されるか確認。

### UI動作検証
1. **登録**: 定期設定を入力して登録できるか。
2. **表示**: リスト上で定期発注であることがわかるか。
3. **キャンセル**:
   - 「今回のみ」→ その回のステータスのみ変更されること。
   - 「全停止」→ 親レコードのフラグが更新され、翌日のバッチで生成が止まること。
