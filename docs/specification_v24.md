# 薬剤発注ナビ 詳細仕様書

**バージョン**: v24.0 (大規模改善版)  
**最終更新**: 2026-01-02  
**ステータス**: 開発完了・テスト待ち

---

## 1. システム概要

### 1.1 目的
薬剤の発注管理を効率化し、発注漏れを防止するWebアプリケーション。

### 1.2 v24.0 での改善点
- ファイル分割による保守性向上
- エラーハンドリング・バリデーション強化
- 担当者変更機能
- キャッシュ機能（読み込み高速化）
- フィルター・検索機能
- 操作ログ機能
- 一括操作
- 統計ダッシュボード（年度・月別集計）

---

## 2. ファイル構成

| ファイル | 役割 | 行数目安 |
|---------|------|---------|
| Config.gs | 設定定数・ヘルパー関数 | 80行 |
| Validator.gs | 入力バリデーション | 120行 |
| Logger.gs | 操作ログ記録・取得 | 80行 |
| Masters.gs | マスターデータ取得（キャッシュ付き） | 140行 |
| Notify.gs | 各種通知・定期リマインド | 160行 |
| Orders.gs | 発注CRUD・一括操作・統計 | 450行 |
| Code.gs | エントリーポイント・認証 | 60行 |
| styles.html | CSS（分離） | 350行 |
| scripts.html | JavaScript（分離） | 400行 |
| index.html | HTML（UIテンプレート） | 180行 |

---

## 3. 外部連携

### 3.1 スプレッドシート

| マスター名 | ID | カラム構成 | 使用カラム |
|-----------|---|-----------|-----------| 
| スタッフマスター | `1wR-ht-2MFrf2NQFPef2Xol3iQ7qIwXsQv_9T2IImoTM` | A:Email, B:氏名, C:職種, D:所属デポ, E:クロスログID | A, B |
| 患者マスター | `1zD7lIxWrMEzma9GDP0Yltp_YG56pOxVUsYYPNJ3a-nE` | A:homisID, B:TukusiID, C:氏名, D:カナ, E:生年月日, F:性別, G:郵便番号, H:住所, I:電話番号 | C, D |
| データDB | `1ffuhDYZSts3u6YN0vzQX_CwVXWDqRLD2zn3vkFbqtxQ` | シート1, 操作ログ | - |

### 3.2 データDB カラム構成

| 列 | カラム名 | 型 | 必須 |
|----|---------|---|-----|
| A | ID | UUID | ○ |
| B | ステータス | 文字列 | ○ |
| C | 患者名 | 文字列 | ○ |
| D | 薬剤名 | 文字列 | △ |
| E | 発注期限日 | 日付 | ○ |
| F | 投与予定日 | 日付 | - |
| G | 担当者メール | 文字列 | ○ |
| H | イベントID | 文字列 | ○ |
| I | 登録日時 | 日時 | ○ |
| J | 納品確認日時 | 日時 | - |
| K | 納品確認者 | 文字列 | - |

### 3.3 操作ログシート（新規）

| 列 | カラム名 |
|----|---------|
| A | 日時 |
| B | 操作 |
| C | 対象ID |
| D | 詳細 |
| E | 実行者 |

---

## 4. 機能仕様

### 4.1 認証 (step1_SimpleAuth)
- ドメイン検証: `nhw.jp` のみ許可
- エラー時は構造化レスポンス返却

### 4.2 マスターデータ取得 (step2_GetMasters)
- CacheService で10分間キャッシュ
- 2回目以降はキャッシュから取得（高速化）

### 4.3 発注リスト取得 (step3_GetOrders)
- `納品済` を除外
- 発注期限日で昇順ソート
- 担当者メールから名前を解決

### 4.4 新規登録 (registerOrder)
- 入力バリデーション実行
- カレンダーイベント作成
- DB登録
- ログ記録
- Chat通知

### 4.5 データ更新 (updateOrderData)
- 入力バリデーション実行
- 担当者変更対応 (newPicEmail)
- カレンダー同期更新
- ログ記録
- Chat通知

### 4.6 データ削除 (deleteOrder)
- カレンダーイベント削除
- DB行削除
- ログ記録
- Chat通知

### 4.7 ステータス更新 (updateStatus)

| 遷移 | 追加処理 | 通知 |
|------|---------|------|
| 未発注→発注済 | なし | 🟠 |
| 発注済→納品済 | 確認日時・確認者記録 | 🔵 |

### 4.8 一括操作

| 関数 | 機能 |
|------|------|
| bulkUpdateStatus | 複数IDを一括でステータス変更 |
| bulkDelete | 複数IDを一括削除 |

### 4.9 統計データ取得 (getStatistics)
- 年度指定 (4月〜翌3月)
- 月別発注件数
- 担当者別件数
- ステータス別件数
- 期限超過件数

### 4.10 定期リマインド (hourlyAlertTask)

| 条件 | 通知時刻 | アイコン |
|------|---------|---------|
| 1〜3日前 | 9:00 | 🟡 |
| 当日 | 9:00, 12:00, 16:00 | 🟠 |
| 超過 | 毎時 | 🔴 |

---

## 5. UI仕様

### 5.1 画面構成

```
┌─────────────────────────────────────┐
│ ヘッダー                            │
├─────────────────────────────────────┤
│ [発注リスト] [統計]  ← タブ切替     │
├─────────────────────────────────────┤
│ [ステータス▼][担当者▼][🔍検索...]   │
├─────────────────────────────────────┤
│ カードリスト                        │
│ □ 💊 薬剤名         [未発注]       │
│   👤 患者名様        期限:日付      │
├─────────────────────────────────────┤
│ [一括操作バー] ← 選択時表示         │
└─────────────────────────────────────┘
```

### 5.2 統計ダッシュボード

```
┌─────────────────────────────────────┐
│ 📊 統計ダッシュボード [2025年度▼]  │
├─────────────────────────────────────┤
│ [年間件数] [未発注] [発注済] [超過] │
├─────────────────────────────────────┤
│ 月別発注件数（棒グラフ）            │
├─────────────────────────────────────┤
│ 担当者別件数（円グラフ）            │
└─────────────────────────────────────┘
```

---

## 6. バリデーションルール

| 項目 | ルール |
|------|-------|
| 患者名 | 必須, 最大50文字 |
| 薬剤名 | 任意, 最大100文字 |
| 発注期限日 | 必須, yyyy-MM-dd形式 |
| 投与予定日 | 任意, yyyy-MM-dd形式 |
| 担当者メール | 必須, メール形式 |

---

## 7. エラーコード

| コード | 意味 |
|--------|------|
| AUTH_FAILED | 認証失敗 |
| DOMAIN_NOT_ALLOWED | ドメイン不許可 |
| VALIDATION_ERROR | バリデーションエラー |
| NOT_FOUND | データ未検出 |
| CALENDAR_ERROR | カレンダー操作エラー |
| SHEET_ERROR | シート操作エラー |
| UNKNOWN_ERROR | 不明なエラー |

---

## 8. キャッシュ設定

| キー | 内容 | TTL |
|-----|------|-----|
| master_staff | スタッフマスター | 10分 |
| master_patients | 患者マスター | 10分 |

---

## 9. デプロイ手順

1. データDBに「操作ログ」シートを作成（ユーザー作業）
2. GASプロジェクトに全ファイルを貼り付け
3. 「デプロイ」→「新しいデプロイ」
4. デプロイID を CHANGELOG.md に記録

---

## 10. バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v23.0 | 2026-01-02 | 患者検索修正 |
| v24.0 | 2026-01-02 | 大規模改善（ファイル分割、新機能追加） |
